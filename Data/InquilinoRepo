using Inmobiliaria_Zarate_DoNet.Models;
using MySql.Data.MySqlClient;

namespace Inmobiliaria_Zarate_DoNet.Data
{
    /// <summary>ABM de Inquilinos.</summary>
    public class InquilinoRepository
    {
        private readonly DbConexion _db;
        public InquilinoRepository(DbConexion db) => _db = db;

        public List<Inquilino> GetAll()
        {
            var lista = new List<Inquilino>();
            using var conn = _db.CrearConexion();
            const string sql = @"
SELECT id, dni, Apellido AS apellido, nombre, telefono, email, creado_en
FROM inquilino
ORDER BY apellido, nombre;";
            using var cmd = new MySqlCommand(sql, conn);
            using var r = cmd.ExecuteReader();

            int oId = r.GetOrdinal("id");
            int oDni = r.GetOrdinal("dni");
            int oApe = r.GetOrdinal("apellido");
            int oNom = r.GetOrdinal("nombre");
            int oTel = r.GetOrdinal("telefono");
            int oMail = r.GetOrdinal("email");
            int oCre = r.GetOrdinal("creado_en");

            while (r.Read())
            {
                lista.Add(new Inquilino
                {
                    Id = r.GetInt32(oId),
                    Dni = r.GetString(oDni),
                    Apellido = r.GetString(oApe),
                    Nombre = r.GetString(oNom),
                    Telefono = r.IsDBNull(oTel) ? null : r.GetString(oTel),
                    Email = r.IsDBNull(oMail) ? null : r.GetString(oMail),
                    CreadoEn = r.GetDateTime(oCre)
                });
            }
            return lista;
        }

        public Inquilino? GetById(int id)
        {
            using var conn = _db.CrearConexion();
            const string sql = @"
SELECT id, dni, Apellido AS apellido, nombre, telefono, email, creado_en
FROM inquilino
WHERE id = @id;";
            using var cmd = new MySqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@id", id);
            using var r = cmd.ExecuteReader();
            if (!r.Read()) return null;

            int oId = r.GetOrdinal("id");
            int oDni = r.GetOrdinal("dni");
            int oApe = r.GetOrdinal("apellido");
            int oNom = r.GetOrdinal("nombre");
            int oTel = r.GetOrdinal("telefono");
            int oMail = r.GetOrdinal("email");
            int oCre = r.GetOrdinal("creado_en");

            return new Inquilino
            {
                Id = r.GetInt32(oId),
                Dni = r.GetString(oDni),
                Apellido = r.GetString(oApe),
                Nombre = r.GetString(oNom),
                Telefono = r.IsDBNull(oTel) ? null : r.GetString(oTel),
                Email = r.IsDBNull(oMail) ? null : r.GetString(oMail),
                CreadoEn = r.GetDateTime(oCre)
            };
        }

        public int Create(Inquilino i)
        {
            using var conn = _db.CrearConexion();
            const string sql = @"
INSERT INTO inquilino (dni, Apellido, nombre, telefono, email)
VALUES (@dni, @apellido, @nombre, @telefono, @email);
SELECT LAST_INSERT_ID();";
            using var cmd = new MySqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@dni", i.Dni);
            cmd.Parameters.AddWithValue("@apellido", i.Apellido);
            cmd.Parameters.AddWithValue("@nombre", i.Nombre);
            cmd.Parameters.AddWithValue("@telefono", (object?)i.Telefono ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@email", (object?)i.Email ?? DBNull.Value);
            return Convert.ToInt32(cmd.ExecuteScalar());
        }

        public int Update(Inquilino i)
        {
            using var conn = _db.CrearConexion();
            const string sql = @"
UPDATE inquilino
SET dni = @dni,
    Apellido = @apellido,
    nombre = @nombre,
    telefono = @telefono,
    email = @email
WHERE id = @id;";
            using var cmd = new MySqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@dni", i.Dni);
            cmd.Parameters.AddWithValue("@apellido", i.Apellido);
            cmd.Parameters.AddWithValue("@nombre", i.Nombre);
            cmd.Parameters.AddWithValue("@telefono", (object?)i.Telefono ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@email", (object?)i.Email ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@id", i.Id);
            return cmd.ExecuteNonQuery();
        }

        public int Delete(int id)
        {
            using var conn = _db.CrearConexion();
            const string sql = @"DELETE FROM inquilino WHERE id = @id;";
            using var cmd = new MySqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@id", id);
            return cmd.ExecuteNonQuery();
        }

        /// <summary>DNI Ãºnico 
        public bool ExistsDni(string dni, int? excludeId = null)
        {
            using var conn = _db.CrearConexion();
            var sql = @"SELECT COUNT(1) FROM inquilino WHERE dni = @dni";
            if (excludeId.HasValue) sql += " AND id <> @x";
            using var cmd = new MySqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@dni", dni);
            if (excludeId.HasValue) cmd.Parameters.AddWithValue("@x", excludeId.Value);
            return Convert.ToInt32(cmd.ExecuteScalar()) > 0;
        }
    }
}
